name: ğŸš€ Deploy to Fly.io

# Trigger on push to main and PR branches starting with 'claude/'
on:
  push:
    branches:
      - main
      - claude/*
  pull_request:
    branches:
      - main

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # Job 1: Lint and Type Check
  lint:
    name: ğŸ“ Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.18.0
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: âœ¨ Lint backend
        run: cd packages/backend && npm run lint

      - name: âœ¨ Lint frontend
        run: cd packages/frontend && npm run lint

      - name: ğŸ” Type check backend
        run: cd packages/backend && npm run typecheck

      - name: ğŸ” Type check frontend
        run: cd packages/frontend && npm run typecheck

  # Job 2: Build & Test
  test:
    name: ğŸ§ª Build & Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.18.0
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build backend
        run: cd packages/backend && npm run build

      - name: ğŸ”¨ Build frontend
        run: cd packages/frontend && npm run build

      - name: ğŸ§ª Test backend
        run: cd packages/backend && npm run test -- --coverage || true

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./packages/backend/coverage/lcov.info
          flags: backend
          fail_ci_if_error: false

  # Job 3: Security Checks
  security:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.18.0
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run npm audit
        run: npm audit --audit-level=moderate || true

      - name: âœ… Check environment variables
        run: |
          echo "Checking .env.example files..."
          test -f packages/backend/.env.example || echo "âš ï¸ Warning: backend/.env.example missing"
          test -f packages/frontend/.env.example || echo "âš ï¸ Warning: frontend/.env.example missing"

  # Job 4: Deploy to Fly.io
  deploy:
    name: ğŸš€ Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    # Only deploy on push to main or claude/* branches, not on PRs
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/claude/'))
    environment:
      name: production
      url: https://paircam.live
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: ğŸ” Login to Fly.io
        run: flyctl auth token
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: ğŸ“ List Fly.io apps
        run: flyctl apps list
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: ğŸš€ Deploy to Fly.io
        run: |
          cd packages/backend
          flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: ğŸ¥ Smoke Tests
        run: |
          echo "â³ Waiting for deployment to stabilize..."
          sleep 30

          BACKEND_URL="https://paircam.live"

          echo "ğŸ” Testing health endpoint..."
          curl -f -s "$BACKEND_URL/health" || {
            echo "âŒ Health check failed"
            exit 1
          }

          echo "âœ… Backend is responding"

          echo "ğŸ” Testing API endpoint..."
          curl -f -s "$BACKEND_URL/api/health" -H "Accept: application/json" || {
            echo "âš ï¸ API health check failed (might be normal if endpoint not implemented)"
          }

          echo "âœ… Smoke tests passed!"

      - name: ğŸ“Š Get Deployment Status
        if: always()
        run: |
          cd packages/backend
          flyctl status || true
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: ğŸ“¢ Notify Slack Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *Deployment Successful*\n\n*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\n*Author:* ${{ github.actor }}\n*Branch:* ${{ github.ref_name }}\n*URL:* https://paircam.live"
                  }
                }
              ]
            }

      - name: ğŸ“¢ Notify Slack Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âŒ *Deployment Failed*\n\n*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\n*Author:* ${{ github.actor }}\n*Branch:* ${{ github.ref_name }}\n*Log:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
